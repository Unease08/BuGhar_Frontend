import { Box } from "@mui/material";
import { Link, useParams, useNavigate } from "react-router-dom";
import { useState, useEffect } from "react";
import toast from "react-hot-toast";
import api from "../../../library/Api";

const UpdateVulnerability = () => {
  const { id } = useParams(); // Get the ID from the URL parameter
  const navigate = useNavigate();

  // State to store vulnerability details
  const [vulnerability, setVulnerability] = useState({
    vulnerability_name: "",
    vulnerability_description: "",
  });

  // Fetch the vulnerability data when the component mounts
  useEffect(() => {
    const fetchVulnerability = async () => {
      try {
        const response = await api.get(`/vulnerability-type/${id}`);
        console.log("Fetched vulnerability data:", response.data); // Log the response
        setVulnerability({
          vulnerability_name: response.data.name,
          vulnerability_description: response.data.description,
        });
      } catch (error) {
        console.error("Error fetching vulnerability data:", error);
      }
    };
    fetchVulnerability();
  }, [id]);

  // Handle form input changes
  const handleChange = (e) => {
    const { name, value } = e.target;
    setVulnerability({
      ...vulnerability,
      [name]: value,
    });
  };

  // Handle form submission (update operation)
  const handleSubmit = async (e) => {
    e.preventDefault();
    try {
      // Send a PUT request to update the vulnerability
      const response = await api.put(`/vulnerability-type/${id}`, {
        name: vulnerability.vulnerability_name,
        description: vulnerability.vulnerability_description,
      });
      toast.success(response.data.message);
      navigate("/vulnerability"); // Redirect after update
    } catch (error) {
      console.error("Error submitting report:", error);
      const errorMessage =
        (error.response && error.response.data && error.response.data.detail) ||
        "Unknown error occurred";
      toast.error(`Error: ${errorMessage}`);
    }
  };

  return (
    <Box m="20px">
      <div className="text-3xl font-semibold text-white">
        Update Vulnerability
      </div>
      <div className="max-w-8xl mx-auto mt-10 p-6 bg-gray-800 rounded-lg shadow-lg flex flex-col gap-8">
        <form onSubmit={handleSubmit}>
          <div className="grid gap-2 md:grid-cols-1">
            <div>
              <label className="block mb-2 text-lg font-medium text-white">
                Vulnerability Name
              </label>
              <input
                type="text"
                name="vulnerability_name"
                value={vulnerability.vulnerability_name}
                onChange={handleChange}
                className="border text-lg rounded-lg focus:border-blue-500 block w-full p-2.5 bg-gray-700 border-gray-600 placeholder-gray-400 text-white focus:ring-blue-500"
                placeholder="Enter Vulnerability Name"
              />
            </div>

            <div className="mt-3">
              <label className="block mb-2 text-lg font-medium text-white">
                Vulnerability Description
              </label>
              <textarea
                name="vulnerability_description"
                value={vulnerability.vulnerability_description}
                onChange={handleChange}
                rows="8"
                className="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                placeholder="Write your thoughts here..."
              ></textarea>
            </div>
          </div>
          <div className="flex justify-between mt-4">
            <Link to="/vulnerability">
              <button className="text-white bg-gray-500 hover:bg-gray-600 focus:ring-4 focus:outline-none font-medium rounded-lg text-lg w-full sm:w-auto px-5 py-2.5 text-center focus:ring-gray-700">
                Back
              </button>
            </Link>
            <button
              type="submit"
              className="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none font-medium rounded-lg text-lg w-full sm:w-auto px-5 py-2.5 text-center focus:ring-blue-800"
            >
              Submit
            </button>
          </div>
        </form>
      </div>
    </Box>
  );
};

export default UpdateVulnerability;
